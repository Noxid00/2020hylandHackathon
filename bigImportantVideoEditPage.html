<!DOCTYPE HTML>
<html>

<style>

	div.bigGuy{
		width: 90%;
		height: 70px;
		border: 1px solid black;
		overflow-x:scroll;
		white-space: nowrap;
		float: left;
	}
	
	div.SourceClips{
		width: 50%;
		height: 90px;
		border: 1px solid black;
	}
	
	div.emptyCell{
		width: 40px;
		height: 40px;
		border: 5px solid black;
		white-space: nowrap;
		display:inline-block;
	}
	div.segment{
		width: 40px;
		height: 40px;
		border: 5px solid blue;
		white-space: nowrap;
		display:inline-block;
	}

</style>

<head>
<!--
<style>
#div1, #div2 {
  float: left;
  width: 100px;
  height: 35px;
  margin: 10px;
  padding: 10px;
  border: 1px solid black;
}
-->
</style>
<script>
window.onload = initialize;

var segments = [];
var clips = [];
var thumbs = [];
var host = window.location.host;

function initialize(){

	updateClips();
	updateTimeline();

}

function updateClips(){

	var sourceClips = document.getElementById("sourceClips");
	
	while(sourceClips.firstChild){
		sourceClips.removeChild(sourceClips.firstChild);
	}
	
	console.log(clips);
	for(var i = 0; i< clips.length; i++){
		var clip = clips[i];
		console.log(clip);
		var segment = document.createElement("div");
		
		var thisThumb = null;
		
		/*
		for(thumb in thumbs){
		
			if(thumb.id == clip.id){
			
				thisThumb = thumb;
			
			}
		
		}
		
		if(thisThumb == null){
			var newImg = new Image;
			newImg.src = '/THUMBS/'+clip.id+'.png';
			thisThumb = {id:clip.id, image:newImg};
			thumbs.push(thisThumb);
		}
		*/
		
		var newImg = new Image;
		
		newImg.onload = function() {
			console.log("loaded image");
    			segment.src = this.src;
    		}
		
		newImg.src = '/THUMBS/'+clip.id+'.png';
		
		//segment.appendChild(thisThumb.image);//thumbs.src;
		
		segment.draggable = "true";
		segment.ondragstart = "drag(event)";
		
		segment.className = "segment";
		sourceClips.appendChild(segment);
	
	}
	console.log(thumbs);

}

function updateTimeline(){

	var timeline = document.getElementById("timeline");
	
	while(timeline.firstChild){
		timeline.removeChild(timeline.firstChild);
	}
	
	var divs = [];
	
	var newDiv = document.createElement("div");
	
	newDiv.className = "emptyCell";
	timeline.appendChild(newDiv);
	
	for(segment in segments){
	
		
		var segment = document.createElement("div");
		segment.className = "segment";
		timeline.appendChild(segment);
		
		newDiv = document.createElement("div");
		
		newDiv.className = "emptyCell";
		timeline.appendChild(newDiv);
	
	}
	
	

}

function allowDrop(ev) {
  ev.preventDefault();
}

function drag(ev) {
  ev.dataTransfer.setData("text", ev.target.id);
}

function drop(ev) {
	//ev.preventDefault();
	//var data = ev.dataTransfer.getData("text");
	//ev.target.appendChild(document.getElementById(data));
  	var child = ev.target;
  
	var index = 0;
	while( (child = child.previousSibling) != null ){ 
		index++;
	}
	index = index/2;
	segments.splice(index,0,"");
	updateTimeline();
}

function doSubmit(oFormElement){
	console.log("got here");
	var xhr = new XMLHttpRequest();
	xhr.onload = function(){
		
		clips = JSON.parse(xhr.responseText);
		updateClips();
		
	 } // success case
	xhr.onerror = function(){ alert (xhr.responseText); } // failure case
	xhr.open (oFormElement.method, oFormElement.action, true);
	xhr.send (new FormData (oFormElement));
	return false;
	
	
	/*
	var url = host +"/upload";
	fetch(url, {
		method : "POST",
		body: new FormData(document.getElementById("inputform")),
    // -- or --
    // body : JSON.stringify({
        // user : document.getElementById('user').value,
        // ...
    // })
	}).then(
		response => response.text() // .json(), etc.
    // same as function(response) {return response.text();}
	).then(
	html => console.log(html)
	);
	*/
}

</script>
</head>
<body>

<h2>Drag and Drop</h2>
<p>Drag the image back and forth between the two div elements.</p>

<!--
<form id = "inputform">
<input id="file" type="file" name="filetoupload"><br>
<button type="button" onclick="doSubmit()">upload</button>
</form>
-->

<form action="upload" method="post" enctype="multipart/form-data" onsubmit="return doSubmit(this)">
	<input type="file" name="filetoupload"><br>
	<input type="submit">
</form>


<div id="sourceClips" class="SourceClips"></div>

<div id="timeline" class ="bigGuy" ondrop="drop(event)" ondragover="allowDrop(event)"S>
  <!--<img src="img_w3slogo.gif" draggable="true" ondragstart="drag(event)" id="drag1"> 
  -->
</div>



<div id="div2" ondrop="drop(event)" ondragover="allowDrop(event)" width="100"></div>

</body>
</html>
